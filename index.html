<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuentros</title>
    <link rel="stylesheet" href="./styles.css">
    
</head>
<body>
    <div id="loading-wrapper">
        <div id="welcome">
          <div id="logo"></div>
          <p id="underLogo">an augmented documentary</p>
          <pre id="description" class="splitText">
  
            When thinking about home, rather often the first image that comes to mind is a physical space. 
            However, even though that first thought is probably based on the need of a context, 
            the thoughts quickly turn into memories that go beyond the strict materiality of the house. 
            That is, really, where the combination of house and identity turn into what we usually define as home. 

            Home is the virtual house, 
            the time-based abstract layer generated by the inhabitant 
            as a response to the urgency of translating their own identity into space.

            But what happens when the individual perception of that layer collides with that of others?
  
          </pre>
          <button id="enterButton">Enter</button>
        </div>
        <!--<p id="loadingText">loading...</p>
        <div id="particles-js"></div>-->
    </div>
    <!--SITE HTML-->
    <div class="frontcontainer">
        <!--<div>
            <input id="slider" type="range" min="0" max="25" value="25">
        </div>
        <div id="box"></div>-->

        <!--Loading Screen-->
        <section id="loading-screen">
            <div id="loader"></div>
        </section>

        <!--Video Container-->
        <div id="videocontainer">
            <video id="vid0" class="video" preload="auto" loop>
              <source
                src="/videos/BroEntero1-2.mp4"
                type="video/mp4"
              />
              <track id="track1" label="Español" kind="subtitles" srclang="es" src="videos/captionsalvaroESP.vtt" default>
              
              Your browser does not support the video tag.
            </video>
    
            <video id="vid1" class="video" preload="auto" loop>
              <source
                src="/videos/MamaEntero1.mp4"
                type="video/mp4"
              />
              <track id="track2" label="Español" kind="subtitles" srclang="es" src="videos/captionsmumESP.vtt" default>
              
              Your browser does not support the video tag.
            </video>
    
            <video id="vid2" class="video" preload="auto" loop>
              <source
                src="/videos/PapaEntero1.mp4"
                type="video/mp4"
              />
              <track id="track3" label="Español" kind="subtitles" srclang="es" src="videos/captionsdadESP.vtt" default>
              
              Your browser does not support the video tag.
            </video>
            
            
            
        </div>
        <!--Subtitles Container-->
        <div id="subtitles">
            <div class="tracks" id="display1"></div>
            <div class="tracks" id="display2"></div>
            <div class="tracks" id="display3"></div>
        </div>

        <!--<div id="subtitlesEng">
            <div class="tracks" id="displayeng1"></div>
            <div class="tracks" id="displayeng2"></div>
            <div class="tracks" id="displayeng3"></div>
        </div>-->

        <!--Volume Slider-->
        <form class="slider" id="slidervolume">
            <div id="chars">
            <p class="tag">Char. 1</p>
            <p class="tag">Char. 2</p>
            <p class="tag">Char. 3</p>
            </div>
            <input
            type="range"
            name="vidPanner"
            id="vidPanner"
            value="0"
            min="-100"
            max="100"
            step="1"
            />
            <p id="tagSlider1" class="tag">Character Panner</p>
        </form>

        <!--Opacity Slider-->
        <form class="slider" id="slideropacity">
            <div id="opacityTag">
              <output id="rangevalue" class="tag">100</output>
              <p class="tag">Opacity Video</p>
            </div>
            <input
              type="range"
              name="bgopacity"
              id="bgopacity"
              value="100"
              min="0"
              max="100"
              step="1"
              oninput="rangevalue.value=value"
            />
            
          </form>
        
        <button id="subButton">CC</button>
        <div id="subMenu">
            <button id="esp" class="langButton">ESP</button>
            <button id="eng" class="langButton">ENG</button>
        </div>
        <!--Scene Container-->
        <div class="scene"></div>
    
    </div>

    
    <!--THREE JS DEPENDENCIES-->
    <script src="./three.min.js"></script>
    <script src="./PLYLoader.js"></script>
    <script src="./OrbitControls.js"></script>
    <script src="./tweenjs.min.js"></script>

    <!--<script src="./snow.js"></script>
    <script src="./app.js"></script>-->
    
    <!--THREE JS SCENE-->
    <script>
        // Variables for setup

        let container;
        let camera;
        var renderer;
        let scene;
        scene = new THREE.Scene();
        let crystal;

        var PARTICLE_COUNT = 3000;
        //var snowflakePath = './snowsprite.png';

        //var snowflakeTexture = new THREE.TextureLoader().load(snowflakePath);

        var frame = 0;
        var particles = [];
        var geometry = new THREE.Geometry();

        
        //material
        const material = new THREE.PointsMaterial({
                    size: 0.05,
                    vertexColors: THREE.VertexColors,
                    transparent: true,
                    opacity: 1,
                });

        //material.needsUpdate = true;

        const materialDad = new THREE.PointsMaterial({
                    size: 0.05,
                    vertexColors: THREE.VertexColors,
                    transparent: true,
                    opacity: 1,
                });

        const materialMum = new THREE.PointsMaterial({
            size: 0.05,
            vertexColors: THREE.VertexColors,
            transparent: true,
            opacity: 1,
        });

        const materialBro = new THREE.PointsMaterial({
            size: 0.05,
            vertexColors: THREE.VertexColors,
            transparent: true,
            opacity: 1,
        });

        const materialCocina = new THREE.PointsMaterial({
            size: 0.05,
            vertexColors: THREE.VertexColors,
            transparent: true,
            opacity: 1,
        });

        function init(){
            container = document.querySelector('.scene');

            //Create Scene
            

            //Camera setup
            const fov = 35;
            const aspect = container.clientWidth / container.clientHeight;
            const near = 0.1;
            const far = 5000;

            camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
            camera.position.set(-100, 120, -100);

            
            //Lights

            const ambient = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambient);

            const light = new THREE.DirectionalLight(0x404040, 5);
            light.position.set(0, 2, 0);
            scene.add(light);

            //Renderer
            renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            //renderer.setAnimationLoop( render );

            container.appendChild(renderer.domElement);

            //Controls
            const controls = new THREE.OrbitControls( camera, renderer.domElement );
            controls.update();


            //Tween Js Ticker

            createjs.Ticker.timingMode = createjs.Ticker.RAF;
            createjs.Ticker.addEventListener("tick", animate);

            


            /*const loadingManager = new THREE.LoadingManager();
            
            loadingManager.onLoad = function(){
	
                console.log('loaded');
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.classList.toggle('fadeout');
                
                // optional: remove loader from DOM via event listener
                loadingScreen.addEventListener( 'transitionend', onTransitionEnd );
                
            };*/


            // SLIDERS

            let slider = document.querySelector('#vidPanner');
            //let box = document.querySelector('#box');

            slider.addEventListener('input', (e) => {
                
                //box.style.opacity = e.currentTarget.value*0.01;
                
                let val = e.currentTarget.value;
                console.log(val);
                //let val = this.value * .01;

                //bro
                document.querySelector('#vid0').volume = Math.min(1, Math.max(0, -val*0.01 - 0.3));
                document.querySelector('#display1').style.opacity = Math.min(1, Math.max(0, -val*0.01));
                
                materialBro.size = Math.min(1, Math.max(0, -val*0.005));
                materialBro.opacity = Math.min(1, Math.max(0.1, -val*0.01));
                console.log("sizebro: " + materialBro.size);
                console.log("opacitybro: " + materialBro.opacity);


                //dad
                document.querySelector('#vid2').volume = Math.min(1, Math.max(0, val*0.01 + 0.1));
                document.querySelector('#display3').style.opacity = Math.min(1, Math.max(0, val*0.01));

                materialDad.size = Math.min(1, Math.max(0, val*0.005));
                materialDad.opacity = Math.min(1, Math.max(0.1, val*0.01));
                console.log("sizedad: " + materialDad.size);
                console.log("opacitydad: " + materialDad.opacity);

                //mum
                if (val >= 0) {
                    document.querySelector('#vid1').volume = 1 - val*0.01;
                    document.querySelector('#display2').style.opacity = 1 - val*0.01;
                    materialMum.size = Math.min(0.5, Math.max(0, 0.5 - val*0.005));
                    materialMum.opacity = Math.min(1, Math.max(0.1, 1 - val*0.01));
                    console.log("sizemum: " + materialMum.size);
                    console.log("opacitymum: " + materialMum.opacity);

                }
                else { 
                    document.querySelector('#vid1').volume = 1 + val*0.01;
                    document.querySelector('#display2').style.opacity = 1 + val*0.01;
                    materialMum.size = Math.min(0.5, Math.max(0, 0.5 + val*0.005));
                    materialMum.opacity = Math.min(1, Math.max(0.1, 1 + val*0.01));
                    console.log("sizemum: " + materialMum.size);
                    console.log("opacitymum: " + materialMum.opacity);
                    
                    };


            });

            //Load Model

            /*let loader = new THREE.PLYLoader();
            loader.load('./salon_Model_1M.ply', ifLoadedMum);
            loader.load('./despachopapa_Model_1M.ply', loadTest(270, 0, 0));*/
            
            var model1, model2, model3, model4, model5, model6, model7, model8, model9;

            var p1 = loadModel('./models/salon_Model_1M_red.ply').then(result => {  model1 = new THREE.Points(result, materialMum); });
            var p2 = loadModel('./models/DespachoMama2_Model_1Mredto300.ply').then(result => {  model2 = new THREE.Points(result, materialMum); });
            var p3 = loadModel('./models/garaje_Model_1Mtextredto300.ply').then(result => {  model3 = new THREE.Points(result, materialMum); });
            var p4 = loadModel('./models/despachopapa_Model_1Mredto300.ply').then(result => {  model4 = new THREE.Points(result, materialDad); });
            var p5 = loadModel('./models/fotograf_aestudio_Model_1Mredto300.ply').then(result => {  model5 = new THREE.Points(result, materialDad); });
            var p6 = loadModel('./models/porche_Model_1Mredto300.ply').then(result => {  model6 = new THREE.Points(result, materialDad); });
            var p7 = loadModel('./models/Despachoalvaro_Model_1redto300.ply').then(result => {  model7 = new THREE.Points(result, materialBro); });
            var p8 = loadModel('./models/buhardilla_Model_1M_redto300.ply').then(result => {  model8 = new THREE.Points(result, materialBro); });
            var p9 = loadModel('./models/Cocina_Model_2_1Mredto300.ply').then(result => {  model9 = new THREE.Points(result, materialCocina); });

            Promise.all([p1,p2,p3,p4,p5,p6,p7,p8,p9]).then(() => {
                //do something to the model
                model1.position.set(1.34709, 11.05206, 6.60284);
                model2.position.set(-0.67, 25.967, -12.085);
                model3.position.set(-0.919, -3, -30.195);
                model4.position.set(-56.8, 16.1, 13.1);
                model5.position.set(-22.36026, -2.77955, -7.64953);
                model6.position.set(20,9,-10);
                model7.position.set(0,-3,0);
                model8.position.set(-7.9, 39.5, 15.36);

                model9.position.set(-13.17, 11.68, -30.93);
                

                
                model1.scale.set(1.12562, 1.12562, 1.12562);
                model2.scale.set(1,1,1);
                model3.scale.set(0.653, 0.653, 0.653);
                model4.scale.set(0.7, 0.7, 0.7);
                model5.scale.set(1.39359, 1.39359, 1.39359);
                model6.scale.set(2.1,2.1,2.1);
                model7.scale.set(1,1,1);
                model8.scale.set(0.7, 0.7, 0.7);

                model9.scale.set(1,1,1);

                model1.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(270), THREE.Math.degToRad(0), THREE.Math.degToRad(87.65)));
                model2.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(270), THREE.Math.degToRad(0), THREE.Math.degToRad(173)));
                model3.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(270), THREE.Math.degToRad(0), THREE.Math.degToRad(3.9)));
                model4.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(270), THREE.Math.degToRad(0), THREE.Math.degToRad(270)));
                model5.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(270), THREE.Math.degToRad(0), THREE.Math.degToRad(0)));
                model6.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(270), THREE.Math.degToRad(0), THREE.Math.degToRad(87.65)));
                model7.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(270), THREE.Math.degToRad(0), THREE.Math.degToRad(0)));
                model8.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(270), THREE.Math.degToRad(0), THREE.Math.degToRad(270)));


                model9.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(270), THREE.Math.degToRad(0), THREE.Math.degToRad(270)));
                //add model to the scene
                scene.add(model1);
                scene.add(model2);
                scene.add(model3);
                scene.add(model4);
                scene.add(model5);
                scene.add(model6);
                scene.add(model7);
                scene.add(model8);
                scene.add(model9);

                container.addEventListener('allSet', tweenAnim);

                function tweenAnim() {

                    var models = [model1, model2, model3, model4, model5, model6, model7, model8];
                    var m;
                    for(m of models){
                        createjs.Tween.get(m.position, {loop: true}).to({x: -13, y:11.7, z:-31}, 1025000, createjs.Ease.quartOut);
                    };

                    createjs.Tween.get(model1.rotation, {loop: true}).to({z:THREE.Math.degToRad(0)}, 1025000, createjs.Ease.quartOut);
                    createjs.Tween.get(model6.rotation, {loop: true}).to({z:THREE.Math.degToRad(0)}, 1025000, createjs.Ease.quartOut);

                    removeListener();

                    console.log('Thanks for looking here Noah!');


                }

                function removeListener(){
                    container.removeEventListener('allSet', tweenAnim);
                }
                
            
            });

            



            //TWEENS Animation
            //Tween Github Javascript
            /*var tween = new TWEEN.Tween({x:0})
                .to({x:40})
                .onUpdate(function(){
                    model1.position.set(this.x, 0, 0);
                }).start();*/

            //Tween js by CreateJs


            

            
            
            

        };

        //Loading Page
        var sceneLoaded;
        const loadingScreen = document.querySelector('#loading-screen');

        THREE.DefaultLoadingManager.onLoad = function ( ) {

            console.log( 'Loading Complete!');
            
            loadingScreen.classList.toggle('fadeout');

            // optional: remove loader from DOM via event listener
            loadingScreen.addEventListener( 'transitionend', onTransitionEnd );
            console.log( 'Did it fade?');
            sceneLoaded = true;
            

        };

        //Welcome wrapper
        var welcomeFaded;
        let wrapper = document.querySelector('#loading-wrapper');

        document.querySelector('#enterButton').onclick = function(){
            
            wrapper.classList.add('loadingFade');
            wrapper.addEventListener('transitionend', onTransitionEnd);
            welcomeFaded = true;
            
        }

        var assembleGeometry = function() {
            for (var i = 0; i < PARTICLE_COUNT; i++) {
                var particle = {
                    position: new THREE.Vector3(Math.random() * 600 - 400, Math.random() * 300 - 150, Math.random() * 500 - 250),
                    velocity: new THREE.Vector3(0, -Math.random() * 5, 0)
                };
                particles.push(particle);
                geometry.vertices.push(particle.position);
            }
            };

        assembleGeometry();

        var particleMaterial = new THREE.PointsMaterial({ 
            color: '#c2c2c2',
            size: 0.1,
            blending: THREE.AdditiveBlending,
            //transparent: true,
            sizeAttenuation: true,
        }),
        particleSystem = new THREE.Points(geometry, particleMaterial);

        particleSystem.sortParticles = true;
        scene.add(particleSystem);

        function loadModel(url) {
            return new Promise(resolve => {
                new THREE.PLYLoader().load(url, resolve);
            });
        }


        window.addEventListener( 'resize', onWindowResize, false );

        function onWindowResize(){

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );

        };

        /*function loadTest(x=0, y=0, z=0){
        return function ifLoadedDad(model){

            console.log(model);
        
            const points = new THREE.Points(model, materialDad);

            points.rotation.setFromVector3(new THREE.Vector3(THREE.Math.degToRad(x), THREE.Math.degToRad(y), THREE.Math.degToRad(z)));

            //console.log(points.rotation);

            scene.add(points);

            //crystal = gltf.scene.children[0];

            //renderer.render(scene, camera);
            //animate();


        };};

        function ifLoadedMum(model){

            console.log(model);

            const points = new THREE.Points(model, materialMum);

            points.rotation.x = THREE.Math.degToRad(270);

            scene.add(points);

            //crystal = gltf.scene.children[0];

            //renderer.render(scene, camera);
            //animate();


        };

        

        function render() {

            
            
            
        };*/

        var i = 0;

        function animate() {
            //renderer.setAnimationLoop(animate); //Activate it without Tween!!!!!!!!!!!
            //particleSystem.rotation.y = frame / 350
            //particleSystem.rotation.z = frame / 500;

            

            particleSystem.rotation.y = frame / 6000;

            for (i = 0; i < PARTICLE_COUNT; i++) {
                if (geometry.vertices[i].y < -120) {
                    geometry.vertices[i].y = 120;
                }
                geometry.vertices[i].y += particles[i].velocity.y / 7;
            }

            frame++;
            renderer.render( scene, camera );
            
        };

        function onTransitionEnd( event ) {

            const element = event.target;
            element.remove();

            //Play the videos only if both welcome and loaded are finished
            if(sceneLoaded && welcomeFaded){
                
                let vid = document.querySelectorAll('.video');
                var eventAllSet = new CustomEvent("allSet");
                container.dispatchEvent(eventAllSet);
                console.log("All Set!");
                vid.forEach(video => {
                    video.play();
                });
            }else{console.log('Not done here yet')};

            

        };

        init();
        animate();

        /*function animate(){
            requestAnimationFrame(animate);
            crystal.rotation.y += 0.005;
            renderer.render(scene, camera);
        }

        function render() {

            
            renderer.render( scene, camera );

            stats.update();

        };*/

        //init();


        

    </script>

    <!--SLIDER OPACITY-->
    <script>
        document.querySelector('#bgopacity').addEventListener('input', function (value) {
            let vid = document.querySelectorAll('.video');
            let vidContainer = document.querySelector('#videocontainer');
            let subtitles = document.querySelector("#subtitles");

            if (this.value == 0){

                console.log("value 0");
                vidContainer.style.display = "none";
                var eventZero = new CustomEvent("zeroOpacity");
                document.querySelector('#bgopacity').dispatchEvent(eventZero);


            } else{

                vid.forEach((video) => {
                console.log("opacity changed");
                video.style.opacity = this.value * .01;
                vidContainer.style.display = "flex";
                });
                subtitles.style.bottom = Math.max(10, this.value*0.27) + "vh";
            }
            
                
            //document.querySelector('.video').style.display = "none";
            
        });
    </script>

    <!--SUBTITLES-->
    <script type="text/javascript">

        // don't add this listener until all DOM content is loaded

        document.addEventListener("DOMContentLoaded", function () {
            let track2 = document.getElementById("track2");
            track2.addEventListener("cuechange", function () {
                let myTrack = this.track;
                let myCues = myTrack.activeCues;      // array of current cues.
                //  display the start and end time, and cue text
                if (myCues.length > 0) {
                    let disp = document.getElementById("display2");
                    disp.innerHTML = myCues[0].getCueAsHTML().textContent;
                }
            }, false);
        
            let track1 = document.getElementById("track1");
            track1.addEventListener("cuechange", function () {
                let myTrack = this.track;
                let myCues = myTrack.activeCues;      // array of current cues.
                //  display the start and end time, and cue text
                if (myCues.length > 0) {
                    let disp = document.getElementById("display1");
                    disp.innerHTML = myCues[0].getCueAsHTML().textContent;
                }
            }, false);
        
            let track3 = document.getElementById("track3");
            track3.addEventListener("cuechange", function () {
                let myTrack = this.track;
                let myCues = myTrack.activeCues;      // array of current cues.
                //  display the start and end time, and cue text
                if (myCues.length > 0) {
                    let disp = document.getElementById("display3");
                    disp.innerHTML = myCues[0].getCueAsHTML().textContent;
                }
            }, false);

            
        }, false);


        let subButton = document.querySelector('#subButton');
        let subEsp = document.querySelector('#subtitles');
        let subMenu = document.querySelector('#subMenu');
        let subEng = document.querySelector('#subtitlesEng');
        let espButton = document.querySelector('#esp');
        let engButton = document.querySelector('#eng');

        var lang;

        let track = document.querySelector('track');

        subButton.onclick = toggleSubs;
        espButton.onclick = toggleEsp;
        engButton.onclick = toggleEng;

        function toggleSubs(){
            let visibilityCont = subEsp.style.display;
            let visibilityMenu = subMenu.style.display;
            
            lang = "esp";

            subButton.classList.toggle('selected');
            espButton.classList.add('selected');

            subEsp.style.display = (visibilityCont === "flex" ? "none" : "flex");

            subMenu.style.display = (visibilityMenu === "block" ? "none" : "block");

        } 

        function toggleEsp(){
            if(lang === "eng"){
                lang = "esp";
                espButton.classList.toggle('selected');
                engButton.classList.toggle('selected');
                document.querySelector('#track1').src = "videos/captionsalvaroESP.vtt";
                document.querySelector('#track2').src = "videos/captionsmumESP.vtt";
                document.querySelector('#track3').src = "videos/captionsdadESP.vtt";
            }
        }

        function toggleEng(){
            if(lang === "esp"){
                lang = "eng";
                espButton.classList.toggle('selected');
                engButton.classList.toggle('selected');
                document.querySelector('#track1').src = "videos/captionsalvaroENG2.vtt";
                document.querySelector('#track2').src = "videos/captionsmumENG.vtt";
                document.querySelector('#track3').src = "videos/captionsdadENG.vtt";
            }
        }


    </script>

    <!--<script>
        let slider = document.querySelector('#slider');
        let box = document.querySelector('#box');

        slider.addEventListener('input', (e) => {
            
            box.style.opacity = e.currentTarget.value*0.01;

            material.size = e.currentTarget.value*0.01;


        });
    </script>-->
    
</body>
</html>